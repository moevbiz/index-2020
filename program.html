<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="">
    <link rel="stylesheet" href="./assets/css/styles.css">
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
    <script type="text/javascript" src="./assets/js/activearea.js"></script>
    <script type="text/javascript" src="./assets/js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="./assets/js/main.js"></script>
    <title>Independent Space Index 2020</title>
</head>
<body data-namespace="program" data-view="program">
    <canvas id="canvas" style="z-index: -1000"></canvas>
    <main>
        <div class="terrorize program-header"
        style="
        position: fixed;
        left: 500px;
        top: 0;
        pointer-events: none;
        ">
            Independent
            <br>
            Space 
            <br>
            Index 
            <br>
            2020
        </div>
        <div class="filters">
            <div class="filter-row filter-row-dates">
                <button class="reset-button filter date-filter" data-date="22">
                    22
                </button>,
                <button class="reset-button filter date-filter" data-date="23">
                    23
                </button>,
                <button class="reset-button filter date-filter" data-date="24">
                    24
                </button>
            </div>
            <div class="filter-row filter-row-districts" style="display: none">
                <div class="active">
                    All districts
                </div>
            </div>
        </div>
        <div class="participants">

        </div>
    </main>
    <div id="map">
        <div class="activeArea"></div>
    </div>
    <svg xmlns="http://www.w3.org/2000/svg" version="1.1" style="height: 0">
        <defs>
          <filter id="goo">
            <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
            <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo" />
            <feBlend in="SourceGraphic" in2="goo" />
            </filter>
        </defs>
    </svg>
</body>
<script>
    $(document).ready(function () {
        toFormat(document.querySelectorAll('.terrorize'));
    });

    document.addEventListener('click', function(e) {
        console.log(e.target)
        if (e.target.classList.contains('filter')) {
            console.log('filter');
            dateView(e.target.dataset.date)
        }
    })

    const api = `api/participants`;

    async function getData() {
        let response = await fetch(api);
        let data = await response.json()
        return data;
    }

    getData()
    .then(data => init(data));

    let events = [];
    let participatingSpaces = [];
    let jsonFeatures = [];

    function getSpace(spaceId) {
        return participatingSpaces.find(element => element.spaceId == spaceId)
    }

    function init(data) {
        let districts = [];
        console.log(data)

        let elements = [];
        data.forEach(participant => {
            elements.push(makeDiv(participant))
            participatingSpaces.push(participant)
            console.log(participant)
            var feature = {type: 'Feature',
                    properties: participant,
                    geometry: {
                        type: 'Point',
                        coordinates: [participant.lng, participant.lat]
                    }
                };
            jsonFeatures.push(feature);
        })
        console.log(elements)
        elements.forEach(element => {
            document.querySelector('.participants').insertAdjacentHTML('beforeend', element)
        })

        districts.sort((a,b)=>a-b)
        districts.forEach(district => {
            makeDistrictDiv(district)
        })

        geojsonLayer = L.geoJson(jsonFeatures, {
            style: function(feature) {
                return {
                    // color: '#ff0000'
                };
            },
            pointToLayer: function(feature, latlng) {
                return new L.marker(latlng, {
                    icon: L.divIcon({
                        className: `marker-icon ${params.space && params.space == feature.properties.spaceId ? '' : 'hidden'}`,
                        html: `<span>${feature.properties.space}</span>`
                    })
                })
            },
            onEachFeature: function (feature, layer) {
                // layer.bindPopup(
                //     String(`<a href="${feature.properties.website}">${feature.properties.space}</a>` + '<br>' +
                //     feature.properties.address + ', ' + toPLZ(feature.properties.district) + ' Vienna<br>' +
                //     `<a href="${feature.properties.website}">${feature.properties.website}</a>`)
                // );
            }
        });

        map.addLayer(geojsonLayer);

        geojsonLayer.on("click", function (event) {
            var clickedMarker = event.layer;
            console.log(clickedMarker)
        });

        if (params.space) {
            let spaceCoords = [getSpace(params.space).lat, getSpace(params.space).lng]
            map.flyTo(spaceCoords, 15)
        }

    }

    function makeDiv(participant) {
        let element = `
            <div class="participant 
            ${params.space && params.space == participant.spaceId ? '' : 'hidden'}"
            data-date="23"
            data-space-id="${participant.spaceId}">
                <h3><span class="terrorize program-header program-header-inline">${participant.space}</span></h3>
                <p>
                ${participant.address},
                ${formatDistrict(participant.district, 'plz')}
                <br>
                ${participant.website}
                </p>
                ${Object.keys(participant.events).map(function (key) {
                    return `<li>${participant.events[key].title}</li>`
                }).join("")}
            </div>
        `
        return element
    }

    function makeDistrictDiv(district) {
        let element = `
            <div>
                ${formatDistrict(district, 'ordinal')}
            </div>
        `
        return document.querySelector('.filter-row-districts').insertAdjacentHTML('beforeend', element)
    }

    function formatDistrict(district, format) {
        if (format == 'ordinal') return toOrdinalSuffix(district)
        if (format == 'plz') return toPLZ(district)
    }

    const toOrdinalSuffix = num => {
        const int = parseInt(num),
            digits = [int % 10, int % 100],
            ordinals = ['st', 'nd', 'rd', 'th'],
            oPattern = [1, 2, 3, 4],
            tPattern = [11, 12, 13, 14, 15, 16, 17, 18, 19];
        return oPattern.includes(digits[0]) && !tPattern.includes(digits[1])
            ? int + ordinals[digits[0] - 1]
            : int + ordinals[3];
    }

    const toPLZ = num => {
        if (num < 10) {
            num = `0${num}`
        }
        const PLZ = `1${num}0`
        return PLZ;
    };

    function duration(startDate, startTime, endDate, endTime) {
        start = new Date(startDate + ' ' + startTime)
        end = new Date(endDate + ' ' + endTime)
        if (start < end) {
            if (start.getDate() == end.getDate()) return `${start.getDate()}. October, ${start.getTime()} — ${end.getTime()}`
        }
    }

    // init map
    // const map = L.map('map', {
    //     zoomControl: false,
    //     zoomSnap: 0.5,
    // }).setView([48.2082, 16.3738], 13);

    const map = new L.Map('map', {
        zoomControl: false,
        zoomSnap: 0.5,
    })
    .setView([48.2082, 16.3738], 13)
    .setActiveArea('activeArea', true);

    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/256/{z}/{x}/{y}@2x?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'independentspaceindex/ckerm5tiz79eu19s6nti3hpvq',
        accessToken: 'pk.eyJ1IjoiaW5kZXBlbmRlbnRzcGFjZWluZGV4IiwiYSI6ImNrNW1tbjA5bDAza24zZXBkanFlc2ppcTQifQ.JnL1exWS78WBLlZrXn6BuQ'
    }).addTo(map);


    // views
    const spaceView = (spaceId) => {
        let divs = document.querySelectorAll('[data-space-id]')
        divs.forEach(div => {
            if (div.dataset.spaceId == spaceId) {
                div.classList.remove('hidden')
            } else {
                div.classList.add('hidden')
            }
        })
        // let spaceCoords = [getSpace(spaceId).lat, getSpace(spaceId).lng]
        // map.flyTo(spaceCoords)
        document.body.dataset.view="space"
    }

    const dateView = (date) => {
        let divs = document.querySelectorAll('[data-date]')
        divs.forEach(div => {
            let dates = div.dataset.date.split('+')
            if (dates.includes(date)) {
                div.classList.remove('hidden')
            } else {
                div.classList.add('hidden')
            }
        })
        document.body.dataset.view="date"
    }


    // params

    var params = getSearchParameters();

	function getSearchParameters() {
		var prmstr = window.location.search.substr(1);
		return prmstr != null && prmstr != "" ? transformToAssocArray(prmstr) : {};
	}
	
	function transformToAssocArray( prmstr ) {
		var params = {};
		var prmarr = prmstr.split("&");
		for ( var i = 0; i < prmarr.length; i++) {
			var tmparr = prmarr[i].split("=");
			params[tmparr[0]] = tmparr[1];
		}
		return params;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        if (params.space) {
            console.log(params.space)
            spaceView(params.space)
        }
    })

</script>
</html>